// ==UserScript==
// @name         meaningful-forks
// @homepage     https://github.com/aflowofcode/meaningful-forks
// @namespace    http://tampermonkey.net/
// @version      1.1.0
// @description  Sort Github fork lists by the number of stars and commits ahead from the source repo.
// @author       Kevin Li + community
// @match        https://github.com/*/network/members
// @grant        none
// ==/UserScript==
!async function(){let e=new Headers;e.append("Authorization","token <YOUR ACCESS TOKEN>");const t={headers:e},o=document.createElement("span");o.innerText="Gathering 📊data...",o.style.position="fixed",o.style.background="#22f922",o.style.padding="10px",o.style.borderRadius="10px",o.style.zIndex="9999",o.style.left="calc(50% - 60px)",o.style.top="calc(50% - 20px)",document.body.appendChild(o);const r=document.querySelector("#network"),n=r.querySelector("span.current-repository").lastElementChild.getAttribute("href").substring(1);console.log("TCL: currentRepoUrl",n);const a=n.substring(0,n.lastIndexOf("/")),s=`https://api.github.com/repos/${n}/forks?sort=stargazers`;console.log("TCL: forkApiUrl",s);let i=await fetch(s,t).then(e=>{if(e.ok)return e.json();throw new Error(`Failed to get the api url, exiting with status: ${e.status}`)}).then(e=>e).catch(e=>{console.log(e),o.innerText="Problem accessing API. If this always happens here, this repo probably doesn't allow API access 😕",setTimeout(()=>{o.remove()},7500)}),l=[];await Promise.all(i.map(async e=>{if(e.forks>0){console.log(`${e.full_name} has ${e.forks} subforks`);let o=await fetch(e.forks_url+"?sort=stargazers",t);(await o.json()).forEach(t=>{t.pushed_at!==e.pushed_at&&(t.is_subfork=!0,t.forked_from=e.full_name,l=l.concat(t))})}})),console.log(`Found ${l.length} relevant subforks`,l);let c=i.concat(l);console.log("TCL: forks.length: "+c.length);const d=[];let u=[];var h,p,g,f;o.innerText="Updating ✨stars...",await Promise.all(c.map(async(e,o,r)=>{if(void 0===e.owner)return console.log("marking bad fork for delete",o,e),void u.push(o);const n=e.owner.login;if(console.log("TCL: authorName",n,o),"undefined"===n)return;const a=e.stargazers_url;d.push(await fetch(a,t).then(e=>{if(e.ok)return e.json();throw new Error("Network response is not OK!")}).then(e=>{e.forEach(e=>{e.login===n&&r[o].stargazers_count>0&&(console.log(`TCL: starCount of ${n} before: ${r[o].stargazers_count}`),r[o].stargazers_count--,console.log(`TCL: starCount of ${n} after: ${r[o].stargazers_count}`))})}).catch(function(t){console.log("There has been a problem with your fetch operation: ",t.message,e),u.push(o)}))})),console.log(`found ${u.length} forks with bad data out of ${c.length}`,u),u.length>0&&(u=w(u)),await Promise.all(d),c.sort((h="stargazers_count",p=!0,g=parseInt,f=g?function(e){return g(e[h])}:function(e){return e[h]},p=p?-1:1,function(e,t){return e=f(e),t=f(t),p*((e>t)-(t>e))})),console.log("End of modifying stargazer count!"),o.innerText="Sorting 🍴forks (might take a sec)...";let m=await async function(e){return b(`https://api.github.com/repos/${e}`,"default_branch")}(n);async function b(e,o){let r,n=await fetch(e,t);if(!n.ok)throw new Error("Network response is not OK!");if(r=await n.json(),"string"==typeof o)return a(r,o);if(Array.isArray(o))return o.map(e=>a(r,e));function a(e,t){if(t.indexOf(".")>=0){let o=e;return t.split(".").forEach(e=>{o=o[e]}),o}return e[t]}}function y(e){const t="http://www.w3.org/2000/svg";var o=document.createElementNS(t,"svg");o.setAttribute("height",12),o.setAttribute("width",10.5),o.setAttribute("viewBox","0 0 14 16"),o.style["vertical-align"]="middle",o.style.fill="currentColor",o.style.position="relative",o.style.bottom="1px",o.classList.add("opticon","opticon-"+e);var r=document.createElementNS(t,"title"),n=document.createElementNS(t,"path");switch(e){case"star":r.appendChild(document.createTextNode("Number of real stars (excluding author's star)")),n.setAttribute("d","M14 6l-4.9-0.64L7 1 4.9 5.36 0 6l3.6 3.26L2.67 14l4.33-2.33 4.33 2.33L10.4 9.26 14 6z"),n.setAttribute("fill","black");break;case"up":r.appendChild(document.createTextNode("Number of commits ahead")),n.setAttribute("d","M5 3L0 9h3v4h4V9h3L5 3z"),n.setAttribute("fill","#84ed47"),o.setAttribute("viewBox","0 0 10 16"),o.setAttribute("height",16);break;case"flame":r.appendChild(document.createTextNode("Fork may be more recent than upstream.")),n.setAttribute("d","M5.05 0.31c0.81 2.17 0.41 3.38-0.52 4.31-0.98 1.05-2.55 1.83-3.63 3.36-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-0.3-6.61-0.61 2.03 0.53 3.33 1.94 2.86 1.39-0.47 2.3 0.53 2.27 1.67-0.02 0.78-0.31 1.44-1.13 1.81 3.42-0.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52 0.13-2.03 1.13-1.89 2.75 0.09 1.08-1.02 1.8-1.86 1.33-0.67-0.41-0.66-1.19-0.06-1.78 1.25-1.23 1.75-4.09-1.88-6.22l-0.02-0.02z"),n.setAttribute("fill","#d26911")}return n.appendChild(r),o.appendChild(n),o}function w(e){for(let t=0;t<e.length;t++)console.log("deleting:",c[e[t]]),delete c[e[t]];return c=c.filter(e=>void 0!==e),console.log(`${c.length} remaining forks`),[]}await async function(e,t){const o=[];for(let r=0;r<e.length;r++)o.push(t(e[r],r,e));return Promise.all(o)}(c,async(e,t,o)=>{try{const r=e.owner.login,n=e.full_name,s=e.default_branch,i=`https://api.github.com/repos/${n}/compare/${a}:${m}...${r}:${s}`;let[l,c]=await b(i,["ahead_by","behind_by"]);o[t].ahead_by=l,o[t].behind_by=c}catch(e){console.log(e)}if(e.is_subfork&&0===e.ahead_by)return console.log("marking subfork ahead_by 0 for delete",t,e.full_name),void u.push(t)}),console.log(`found ${u.length} subforks ahead_by 0 out of ${c.length}`,u),u.length>0&&(u=w(u)),o.innerText="Rearranging 🔀order...",c.sort(function(){var e=[].slice.call(arguments),t=e.length;return function(o,r){var n,a,s,i,l,c,d;for(d=0;d<t&&(c=0,s=e[d],i="string"==typeof s?s:s.name,n=o[i],a=r[i],void 0!==s.primer&&(n=s.primer(n),a=s.primer(a)),l=s.highToLow?-1:1,n<a&&(c=-1*l),n>a&&(c=1*l),0===c);d++);return c}}({name:"stargazers_count",primer:parseInt,highToLow:!0},{name:"ahead_by",primer:parseInt,highToLow:!0},{name:"behind_by",primer:parseInt,highToLow:!1})),console.log("Beginning of DOM operations!"),c.reverse().forEach(e=>{console.log("TCL: fork",e);const t=e.full_name,o=e.stargazers_count;let n=!1,a=r.querySelectorAll("div.repo");for(let o=0;o<a.length;o++){const r=a[o].lastElementChild.getAttribute("href");if(r){if(r.substring(1)===t){if(n=!0,e.hasOwnProperty("is_subfork")&&e.is_subfork){console.log("adding dagger to subfork");const e=document.createTextNode("‡");a[o].querySelectorAll('img[src$="l.png"]')[0].replaceWith(e)}s(a[o]);break}}}if(!n){console.log(`${t} repo wasn't showing`);const o=document.createElement("div");o.classList.add("repo");const r=document.createElement("img");r.alt="",r.classList.add("network-tree"),r.src="https://github.githubassets.com/images/modules/network/t.png";const n=e.owner.type.toLowerCase(),a=document.createElement("a");a.setAttribute("data-hovercard-type",n);const i=e.owner.login;if("user"===n){const t=e.owner.id;a.setAttribute("data-hovercard-url",`/hovercards?user_id=${t}`)}else"organization"===n&&(a.setAttribute("data-hovercard-url",`/orgs/${i}/hovercard`),a.setAttribute("href",`/${i}`));a.setAttribute("href",`/${i}`),a.setAttribute("data-octo-click","hovercard-link-click"),a.setAttribute("data-octo-dimensions","link_type:self");const l=a.cloneNode(!0);l.style.paddingLeft="4px",l.style.paddingRight="4px",a.innerText=i,l.classList.add("d-inline-block");const c=document.createElement("img");c.classList.add("gravatar");const d=e.owner.avatar_url;c.src=d,c.width="16",c.height="16",c.alt=`@${i}`,l.appendChild(c);const u=document.createElement("a");u.style.paddingRight="4px",u.setAttribute("href",`/${t}`),u.innerText=e.name,o.appendChild(r),o.appendChild(l),o.appendChild(a),o.appendChild(document.createTextNode(" / ")),o.appendChild(u),s(o)}function s(t){console.log("adding status",t);const n=document.createDocumentFragment();if(n.appendChild(y("star")),n.appendChild(document.createTextNode(o+" ")),e.ahead_by>0){const t=y("up");n.appendChild(t),n.appendChild(document.createTextNode(e.ahead_by+" "))}e.ahead_by-e.behind_by>0&&n.appendChild(y("flame")),e.is_subfork&&n.appendChild(document.createTextNode(` (subfork of ${e.forked_from})`)),t.appendChild(n),r.firstElementChild.insertAdjacentElement("afterend",t)}e.hasOwnProperty("stargazers_count")&&console.log("TCL: starCount",e.stargazers_count)}),console.log("finished sorting"),o.remove()}();